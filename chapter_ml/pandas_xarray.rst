pandas と xarray
===================

.. ipython::
  supress::

  import matplotlib.pyplot as plt

Pythonの有名なデータ解析ライブラリに pandas [pandas]_ があります。
pandas は、日々のデータ解析のインターフェースを提供するものです。
その注目すべき特徴の1つが、座標のデータ（labeled data）をうまく扱うことができる点です。

例えば時系列データを扱うとき、時間データと計測値の2つを保持しておく必要が有ります。
ある時間領域を切り出す時は同じ操作を両データに適応する必要が有ります。
またある時刻での計測値を知りたいときは、時間データから対応する要素番号を探しだし、
計測データに対してその要素番号を用いてアクセスすることになります。
これらの操作は前節で紹介した ``np.ndarray`` でももちろん可能ですが、
毎回各自がコーディングしていると時間がかかるだけでなく、ミスの元になります。

このようなデータ解析に必要な汎用的な操作をまとめてインターフェースとして提供しているのがpandasです
（日付関連の操作や、欠損値に対する操作、複数のデータをまとめる操作など、他にも多様な便利機能がまとめられています）。
pandasはアンケート結果や株価の推移など、一般のデータ解析に広く用いられています。

一方でプラズマ計測データなど多くの物理データは、複数の座標軸を持ちます。
例えば、電子温度分布の時間変化データは、計測位置と時間という2つの軸を持つことになります。
ある時間における分布が知りたかったり、ある位置の温度の時間変化が知りたかったりします。
しかし pandas は1次元のデータ（表に表すことのできるデータ）しか扱うことができません。
xarray [xarray]_ は、 pandas を多次元データに拡張したもので、地球科学研究分野から生まれたものです。
まだ新しいライブラリですが、
他種類の多次元データを扱うことの多いプラズマ研究でも有用だと思われますので、ここで紹介します。


xarray のインストール
----------------------

Anaconda distribution を用いて Python 開発環境を整えた人は

.. code-block:: bash

  conda install xarray

としてください。Native の Python を用いている人は

.. code-block:: bash

  pip install xarray

とするとよいでしょう。


xarray の使い方
---------------

ここでは、実際のプラズマ実験データを使ってxarray の使い方を説明します。
核融合科学研究所で計測された Thomson 散乱による電子温度・密度の結果を読み込みましょう。
ファイルの読み込みプログラムを *** に用意しました。
これを `data/eg.py` に保存して以下のように読み込みましょう。

.. ipython:: python

  import xarray as xr  # xarray は xr と省略するのが一般的なようです
  import sys
  sys.path.append('data')
  import eg

  thomson = eg.load('data/thomson@120000.dat')  # thomson データの読み込み
  print(thomson)

まず、``print`` 文を用いた時の出力が綺麗に整形されていることがわかります。
``Dimensions`` の行に ``(R: 140, Time: 300)`` とあるのは、
データは2つの次元 ``Time`` と ``R`` に依存するということを示しています。
``Coordinates`` セクションには、それら軸の座標の値が表示されています。
LHDのThomson散乱では、電子温度や密度その推定誤差などが得られますが、それらが
``Data variables`` セクションに含まれています。

各 ``Coordinates`` や ``Data variables`` にアクセスするには、辞書型のように
``['Te']`` というようにすることでアクセスできます。

.. ipython:: python

  thomson['Te']

このように1種類のデータを選んでも、同時に座標情報が付随していることがわかります。


ラベルを用いたインデクシング
~~~~~~~~~~~~~~~~~~~~~~~~~~

``Coordinate`` セクションに ``Time, R`` が表示されているように、このデータには座標情報も付属します。
``.sel`` メソッドを用いることで、座標軸を元に要素を選択することができます。

.. ipython:: python

  thomson.sel(Time=3000.0, method='nearest')

ここでは、 ``Time`` 軸が 3000.0 に最も近い計測値を取得しています。
``Dimensions`` の行から ``Time`` が消えて ``(R: 140)`` だけになったことからもわかるように、
全ての計測値をインデクシングしていることがわかります。

ある時刻の結果だけグラフに描きたい、ということもよくありますが、
その場合も、 ``.sel`` メソッドを用いることで1行で実現できます。

.. ipython:: python
  name: thomson_fig

  @savefig thomson_plot1.png width=4in
  plt.plot(thomson['R'], thomson['Te'].sel(Time=3000.0, method='nearest'))

時刻範囲の選択も容易です。

.. code-block:: python

  thomson.sel(Time=slice(4000.0, 5000.0))  # 4000.0 - 5000.0 msの間のデータを選択


座標名を利用した操作
~~~~~~~~~~~~~~~~~~~~~~~~~~

xarray では、軸に名前が付いているので、データが格納されている配列の軸の順序
（1つ目の軸が ``Time`` 、2つ目の軸が ``R`` に対応している、など）を覚えておく必要がありません。
例えば、各フレームでの電子温度の中央値を得たい場合、``median`` メソッドを用います。
``dim`` オプション内に、どちら方向に沿った中央値を得たいかを指定します。

.. ipython:: python

  thomson.median(dim='R')  # 'R' 方向の中央値を取ったデータは ''Time'' のみに依存する
  @savefig thomson_plot2.png width=4in
  plt.plot(thomson['Time'], thomson['Te'].median(dim='R'))


座標を用いた異種データの結合
~~~~~~~~~~~~~~~~~~~~~~~~~~

異なる時間間隔で計測されたデータ間を結合したい時もあると思います。
例えば、****



その他の特徴
~~~~~~~~~~~~~~~~~~~~~~~~~~

xarray は他にも様々な便利機能を備えています。

+ 座標を用いた異種データの結合
+ netCDF [netcdf]_ ファイルへの入出力
+ dask [dask]_ を用いたメモリに格納できない規模のデータの取り扱い、並列計算

ここではこれらを説明する紙面の余裕がありませんが、
どれも有用な機能となっています。
xarray の document ページ http://xarray.pydata.org をご参考ください

こういったライブラリができることは、コーディングさえすればNumpyなどでも同様のことができるため、
独自の使用法を習得してまで使おうというインセンティブが湧かないかもしれません。
しかし毎回自身でコーディングすることは、試行錯誤のスピードを低下させるだけでなく、
ケアレスミスも誘発します。

最初に使用法を覚える段階はまどろっこしく自分でコーディングした方が早いように感じますが、
慣れてしまうとこのようなライブラリを用いる方が圧倒的に操作が早く確実になります。
有用なツールの習得に時間をかけるのは、ちょっとした投資と言えるかもしれません。
